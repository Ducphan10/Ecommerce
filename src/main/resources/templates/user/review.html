<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{base::layout(~{::section})}">
<head>
  <meta charset="ISO-8859-1">
  <title>Insert title here</title>
</head>
<body>
<section>
  <div class="container card-sh shadow-lg" style="margin-top: 70px; margin-bottom: 100px; background-color: white; border-radius: 10px;">
    <div class="col-md-12 p-5">
      <div class="row">
        <!-- Thông báo thành công/lỗi -->
        <th:block th:if="${session.succMsg}">
          <p class="text-success alert alert-success text-center" role="alert">[[${session.succMsg}]]</p>
          <th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block>
        </th:block>
        <th:block th:if="${session.errorMsg}">
          <p class="text-danger text-center alert alert-danger">[[${session.errorMsg}]]</p>
          <th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block>
        </th:block>

        <!-- Hiển thị sản phẩm -->
        <div class="col-md-6 text-center">
          <div class="product-image-wrapper p-3 bg-white rounded">
            <img th:src="@{'/img/product_img/' + ${product.image}}"
                 class="img-fluid rounded"
                 alt="Product Image"
                 style="max-width: 400px; height: 370px; object-fit: cover;">
          </div>
        </div>

        <!-- Chi tiết sản phẩm -->
        <div class="col-md-6 product-details p-4 bg-white rounded">
          <h1 class="product-title fs-3 fw-bold mb-3">[[${product.title}]]</h1>
          <p class="description">
            <span class="fw-bold">Description:</span><br>[[${product.description}]]
          </p>
          <p class="details">
            <span class="fw-bold">Product Details:</span><br>
            Status:
            <th:block th:if="${product.stock>0}">
              <span class="badge bg-success">Available</span>
            </th:block>
            <th:block th:unless="${product.stock>0}">
              <span class="badge bg-warning">out of stock</span>
            </th:block>
            <br>Category: [[${product.category}]]<br>Policy: 7 Days Replacement & Return
          </p>
          <p class="price fs-5 fw-bold mb-4">
            Price: [[${product.formattedDiscountPrice}]] VND
            <span class="fs-6 text-decoration-line-through text-secondary">[[${product.formattedPrice}]]</span>
            <span class="fs-6 text-success">Sale [[${product.discount}]]%</span>
          </p>

          <!-- Icon dịch vụ -->
          <div class="row service-icons mb-4">
            <div class="col-md-4 text-success text-center p-2">
              <i class="fas fa-money-bill-wave fa-2x"></i>
              <p>Cash On Delivery</p>
            </div>
            <div class="col-md-4 text-danger text-center p-2">
              <i class="fas fa-undo-alt fa-2x"></i>
              <p>Return Available</p>
            </div>
            <div class="col-md-4 text-primary text-center p-2">
              <i class="fas fa-truck-moving fa-2x"></i>
              <p>Free Shipping</p>
            </div>
          </div>

          <!-- Nút hành động -->
          <th:block th:if="${product.stock>0}">
            <th:block th:if="${user==null}">
              <a href="/signin" class="btn btn-danger btn-custom col-md-12">Thêm vào giỏ hàng</a>
            </th:block>
          </th:block>
          <th:block th:unless="${product.stock>0}">
            <a href="#" class="btn text-white btn-warning btn-custom col-md-12">Hết hàng</a>
          </th:block>
        </div>
      </div>
    </div>
  </div>

  <!-- Review Section -->
  <div class="review-section">
    <link rel="stylesheet" href="/css/review2.css">

    <!-- Add a Review Section -->
    <div class="container">
      <div class="review-form">
        <h5 class="form-title">Add a Review</h5>
        <p class="form-note">Your email address will not be published. Required fields are marked *</p>
        
        <!-- Thông báo khi chưa đủ điều kiện bình luận -->
        <th:block th:unless="${hasOrdered}">
          <div class="alert alert-warning" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            You cannot review this product yet. Please wait until your order is marked as "Delivered" by the admin.
          </div>
        </th:block>

        <!-- Form bình luận chỉ hiển thị khi đã đủ điều kiện -->
        <th:block th:if="${hasOrdered}">
          <form th:action="@{/user/reviews/{productId}/{orderId}(productId=${product.id}, orderId=${orderId})}" method="post" th:object="${rating}">
            <div class="form-group">
              <label>Your Rating <span class="required">*</span></label>
              <div class="rating-stars">
                <i class="far fa-star" data-value="1" id="st1"></i>
                <i class="far fa-star" data-value="2" id="st2"></i>
                <i class="far fa-star" data-value="3" id="st3"></i>
                <i class="far fa-star" data-value="4" id="st4"></i>
                <i class="far fa-star" data-value="5" id="st5"></i>
              </div>
              <input type="hidden" name="ratingValue" id="ratingValue" th:field="*{star}"/>
            </div>
            <div class="form-group">
              <label>Other Notes (optional)</label>
              <textarea placeholder="Your Comment" th:field="*{content}"></textarea>
            </div>
            <button type="submit" class="submit-btn">Submit Comment</button>
          </form>
        </th:block>
      </div>
    </div>

    <!-- Reviews Section -->
    <div class="container">
      <div class="review-list">
        <h5 class="review-title">Reviews</h5>
        <p class="review-count" th:text="${ratingUser} + ' Review for this product'"></p>
        <ul class="reviews">
          <th:block th:each="rating : ${ratings}">
            <li class="review-item">
              <div class="review-header">
                <img src="/img/ngdungtr.jpg" alt="User Avatar" class="review-avatar">
                <div class="review-info">
                  <h6 class="reviewer-name" th:text="${rating.getUser().getName()}"></h6>
                  <div class="review-stars">
                    <th:block th:with="star=${rating.getStar()}">
                      <th:block th:if="${star > 0}">
                        <th:block th:each="i : ${#numbers.sequence(1, star)}">
                          <i class="fas fa-star"></i>
                        </th:block>
                      </th:block>
                      <th:block th:if="${star < 5}">
                        <th:block th:each="i : ${#numbers.sequence(1, (5 - star))}">
                          <i class="far fa-star"></i>
                        </th:block>
                      </th:block>
                    </th:block>
                  </div>
                </div>
              </div>
              <p class="review-content" th:text="${rating.getContent()}"></p>
            </li>
          </th:block>
        </ul>
      </div>
    </div>
  </div>

  <!-- woocommerce-tabs -->

  <!-- Modernizer JS -->
  <div th:insert="~{/user/fragments/script::script}"></div>
  <!--Tạo số sao-->
  <script>
    $(document).ready(function() {
      // Tạo trường nội lưu giá trị rating
      const ratingValueInput = $("#ratingValue");

      // Gắn sự kiện click cho tất cả các sao
      $(".fa-star").click(function() {
        // Lấy ID của người sao được click
        const starId = $(this).attr("id");
        // Lấy số sao từ ID (st1 -> 1, st2 -> 2, ...)
        const rating = starId.replace("st", "");

        // Cập nhật giá trị vào trường nội
        ratingValueInput.val(rating);

        // Đặt lại tất cả các sao về màu vàng mặc định
        $(".fa-star").css("color", "#ffc107"); // Màu vàng (hoặc màu bạn muốn)

        // Tô màu xanh cho các sao từ 1 đến giá trị rating
        for (let i = 1; i <= rating; i++) {
          $("#st" + i).css("color", "#007bff"); // Màu xanh (hoặc màu bạn chọn)
        }
      });
    });


  </script>

</section>
</body>
</html>
